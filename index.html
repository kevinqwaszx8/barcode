<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>盤點掃條碼工具</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- 條碼/QRCode 掃描套件：html5-qrcode -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <!-- 產生 Excel .xlsx 用的套件 SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
            margin: 10px;
        }
        h1 {
            font-size: 20px;
            margin-bottom: 8px;
        }
        .section {
            border: 1px solid #ccc;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 6px;
        }
        label {
            display: block;
            margin-top: 6px;
            font-size: 14px;
        }
        input, button, select, textarea {
            font-size: 16px;
            padding: 4px;
            margin-top: 2px;
        }
        button {
            margin-right: 6px;
            margin-top: 8px;
        }
        #reader {
            width: 100%;
            max-width: 400px;
            margin-top: 6px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 4px;
            text-align: center;
        }
        th {
            background: #f0f0f0;
        }
        .small {
            font-size: 12px;
            color: #666;
        }
        .expiry-row {
            display: flex;
            gap: 4px;
            align-items: center;
            flex-wrap: wrap;
        }
        #last-result {
            font-size: 13px;
            color: #333;
            margin-top: 4px;
        }
    </style>
</head>
<body>
<h1>盤點掃條碼工具（手機版）</h1>

<div class="section">
    <strong>說明：</strong>
    <ul class="small">
        <li>每一支手機的資料都存在自己的裝置內，不會和其他手機互相干擾</li>
        <li>資料會一直留在這支手機裡，重新整理 / 關掉再打開都還在</li>
        <li>匯出 Excel 之後資料也會保留，除非你自己刪除或按「清空全部」</li>
    </ul>
</div>

<!-- 使用者區塊 -->
<div class="section">
    <h2 style="font-size: 16px; margin: 0 0 4px 0;">0. 使用者</h2>
    <label>
        使用者名稱：
        <input type="text" id="user" placeholder="例如：小明、早班人員">
    </label>
    <div class="small">
        使用者名稱只跟著目前這一份資料，不會永久記錄到裝置設定。<br>
        每一筆資料會把「使用者」一起寫入 Excel。
    </div>
</div>

<!-- 掃描區塊 -->
<div class="section">
    <h2 style="font-size: 16px; margin: 0 0 4px 0;">1. 條碼掃描</h2>
    <button id="start-scan">開始掃描</button>
    <button id="stop-scan">停止掃描</button>
    <div id="reader"></div>
    <div id="last-result" class="small">最後掃描結果：尚未掃描</div>
    <div class="small" style="margin-top:4px;">
        若無法開啟相機，請確認：<br>
        1. 網址是 <strong>https</strong>（GitHub Pages 已符合）<br>
        2. 手機已允許瀏覽器使用相機<br>
        3. 掃一般商品條碼（EAN-13 / UPC / CODE-128 等）
    </div>
</div>

<!-- 資料輸入區 -->
<div class="section">
    <h2 style="font-size: 16px; margin: 0 0 4px 0;">2. 資料輸入</h2>

    <label>
        條碼：
        <input type="text" id="barcode" placeholder="掃描後自動帶入，也可手動輸入">
    </label>

    <label>
        品名：
        <input type="text" id="name" placeholder="例如：得膚寶乳膏 15g">
    </label>

    <label>
        效期（西元年 / 月 / 日）：
        <div class="expiry-row">
            <select id="exp-year">
                <option value="">年</option>
            </select>
            <span>年</span>
            <select id="exp-month">
                <option value="">月</option>
                <option value="1">1</option><option value="2">2</option>
                <option value="3">3</option><option value="4">4</option>
                <option value="5">5</option><option value="6">6</option>
                <option value="7">7</option><option value="8">8</option>
                <option value="9">9</option><option value="10">10</option>
                <option value="11">11</option><option value="12">12</option>
            </select>
            <span>月</span>
            <select id="exp-day">
                <option value="">日</option>
            </select>
            <span>日（可留白）</span>
        </div>
    </label>

    <label>
        數量：
        <input type="number" id="qty" min="1" value="1">
    </label>

    <label>
        備註（例如：門市/庫房位置）：
        <input type="text" id="note" placeholder="可不填">
    </label>

    <button id="add-row">加入清單</button>
</div>

<!-- 清單與下載 -->
<div class="section">
    <h2 style="font-size: 16px; margin: 0 0 4px 0;">3. 目前清單</h2>
    <table>
        <thead>
        <tr>
            <th>#</th>
            <th>使用者</th>
            <th>條碼</th>
            <th>品名</th>
            <th>效期</th>
            <th>數量</th>
            <th>備註</th>
            <th>建立時間</th>
            <th>刪除</th>
        </tr>
        </thead>
        <tbody id="table-body">
        </tbody>
    </table>
    <button id="download-xlsx">下載 Excel</button>
    <button id="clear-all">清空全部</button>
    <div class="small">⚠️ 清空全部會把這支手機目前的盤點資料全部刪除，且無法復原。</div>
</div>

<script>
    // ===== 基本變數 =====
    const STORAGE_KEY = "inventory_records_v2";  // 每支手機自己的資料空間

    const records = [];  // 目前這一輪的資料（會同步到 localStorage）

    const userInput    = document.getElementById("user");
    const barcodeInput = document.getElementById("barcode");
    const nameInput    = document.getElementById("name");
    const expYearSel   = document.getElementById("exp-year");
    const expMonthSel  = document.getElementById("exp-month");
    const expDaySel    = document.getElementById("exp-day");
    const qtyInput     = document.getElementById("qty");
    const noteInput    = document.getElementById("note");
    const tableBody    = document.getElementById("table-body");
    const lastResultEl = document.getElementById("last-result");

    const startScanBtn    = document.getElementById("start-scan");
    const stopScanBtn     = document.getElementById("stop-scan");
    const addRowBtn       = document.getElementById("add-row");
    const downloadXlsxBtn = document.getElementById("download-xlsx");
    const clearAllBtn     = document.getElementById("clear-all");

    let html5QrCode = null;
    let scanning = false;

    // ===== 工具：取得本機時間字串（YYYY-MM-DD HH:MM:SS） =====
    function getLocalDateTimeString() {
        const now = new Date();
        const pad = n => String(n).padStart(2, "0");
        const y = now.getFullYear();
        const m = pad(now.getMonth() + 1);
        const d = pad(now.getDate());
        const hh = pad(now.getHours());
        const mm = pad(now.getMinutes());
        const ss = pad(now.getSeconds());
        return `${y}-${m}-${d} ${hh}:${mm}:${ss}`;
    }

    // ===== 儲存 / 載入：資料永遠保留，除非手動清除 =====
    function saveRecordsToStorage() {
        try {
            const obj = {
                records: records
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
        } catch (e) {
            console.warn("儲存資料到 localStorage 失敗：", e);
        }
    }

    function loadRecordsFromStorage() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return;
            const obj = JSON.parse(raw);
            if (!obj || !Array.isArray(obj.records)) return;

            obj.records.forEach(r => records.push(r));
            renderTable();
        } catch (e) {
            console.warn("載入資料從 localStorage 失敗：", e);
        }
    }

    // ===== 初始化：效期選單 + 載入既有資料 =====
    (function init() {
        const now = new Date();
        const currentYear = now.getFullYear();
        const maxYear = currentYear + 10;

        for (let y = currentYear; y <= maxYear; y++) {
            const opt = document.createElement("option");
            opt.value = y;
            opt.textContent = y;
            expYearSel.appendChild(opt);
        }

        for (let d = 1; d <= 31; d++) {
            const opt = document.createElement("option");
            opt.value = d;
            opt.textContent = d;
            expDaySel.appendChild(opt);
        }

        loadRecordsFromStorage();
    })();

    // ===== 1. 開始 / 停止 掃描 =====
    startScanBtn.addEventListener("click", async function() {
        try {
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("reader");
            }
            if (scanning) return;

            const config = {
                fps: 10,
                qrbox: { width: 320, height: 200 },
                formatsToSupport: [
                    Html5QrcodeSupportedFormats.EAN_13,
                    Html5QrcodeSupportedFormats.EAN_8,
                    Html5QrcodeSupportedFormats.UPC_A,
                    Html5QrcodeSupportedFormats.UPC_E,
                    Html5QrcodeSupportedFormats.CODE_128,
                    Html5QrcodeSupportedFormats.CODE_39,
                    Html5QrcodeSupportedFormats.CODE_93,
                    Html5QrcodeSupportedFormats.CODABAR
                ],
                experimentalFeatures: {
                    useBarCodeDetectorIfSupported: true
                }
            };

            function onScanSuccess(decodedText, decodedResult) {
                console.log("Scan success:", decodedText, decodedResult);
                barcodeInput.value = decodedText;
                lastResultEl.textContent = "最後掃描結果：" + decodedText;
            }

            function onScanError(errorMessage) {
                // 噪音太多就不顯示，只留在 console
            }

            await html5QrCode.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanError
            );
            scanning = true;
            lastResultEl.textContent = "最後掃描結果：掃描中...";
        } catch (err) {
            console.error("啟動掃描失敗：", err);
            alert("啟動相機失敗，請確認已允許相機權限，或改用 Chrome 試試看。");
        }
    });

    stopScanBtn.addEventListener("click", async function() {
        if (html5QrCode && scanning) {
            try {
                await html5QrCode.stop();
                await html5QrCode.clear();
            } catch (err) {
                console.error("停止掃描失敗：", err);
            }
            scanning = false;
            lastResultEl.textContent = "最後掃描結果：已停止掃描";
        }
    });

    // ===== 2. 加入清單 =====
    addRowBtn.addEventListener("click", function() {
        const user    = userInput.value.trim();
        const barcode = barcodeInput.value.trim();
        const name    = nameInput.value.trim();
        const year    = expYearSel.value;
        const month   = expMonthSel.value;
        const day     = expDaySel.value;
        const qty     = qtyInput.value.trim();
        const note    = noteInput.value.trim();

        if (!barcode) {
            alert("請先輸入或掃描條碼");
            return;
        }
        if (!qty || Number(qty) <= 0) {
            alert("請輸入正確的數量");
            return;
        }

        let expiryDisplay = "";
        let expiryCsv = "";
        if (year || month || day) {
            const y = year || "";
            const m = month ? String(month).padStart(2, "0") : "";
            const d = day ? String(day).padStart(2, "0") : "";
            expiryDisplay = [y, m ? m : "", d ? d : ""].filter(x => x).join("/");
            if (year && month && day) {
                expiryCsv = `${y}-${m}-${d}`;
            } else {
                expiryCsv = expiryDisplay;
            }
        }

        const createdAt = getLocalDateTimeString();

        records.push({
            user:   user,
            barcode: barcode,
            name:    name,
            expiryDisplay: expiryDisplay,
            expiryCsv:     expiryCsv,
            qty:     qty,
            note:    note,
            createdAt: createdAt
        });

        renderTable();
        saveRecordsToStorage();

        barcodeInput.value = "";
        qtyInput.value = 1;
        // 其他欄位保留，方便連續輸入
    });

    function renderTable() {
        tableBody.innerHTML = "";
        records.forEach((rec, index) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td>${rec.user || ""}</td>
                <td>${rec.barcode}</td>
                <td>${rec.name || ""}</td>
                <td>${rec.expiryDisplay || ""}</td>
                <td>${rec.qty}</td>
                <td>${rec.note || ""}</td>
                <td>${rec.createdAt}</td>
                <td><button data-index="${index}">刪除</button></td>
            `;
            tableBody.appendChild(tr);
        });

        Array.from(tableBody.querySelectorAll("button[data-index]")).forEach(btn => {
            btn.addEventListener("click", function() {
                const i = Number(this.getAttribute("data-index"));
                records.splice(i, 1);
                renderTable();
                saveRecordsToStorage();
            });
        });
    }

    // ===== 3. 匯出 Excel .xlsx（不清空資料，條碼為純文字） =====
    downloadXlsxBtn.addEventListener("click", function() {
        if (records.length === 0) {
            alert("目前沒有資料，無法匯出");
            return;
        }

        const data = [];
        data.push(["使用者", "條碼", "品名", "效期", "數量", "備註", "建立時間"]);

        records.forEach(rec => {
            data.push([
                rec.user || "",
                rec.barcode + "",   // ★ 強制用字串
                rec.name || "",
                rec.expiryCsv || rec.expiryDisplay || "",
                rec.qty || "",
                rec.note || "",
                rec.createdAt || ""
            ]);
        });

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);

        // ★ 把條碼那一欄（B 欄）強制設為文字格式
        for (let r = 1; r <= data.length; r++) {
            const cell = ws[`B${r}`];
            if (cell) {
                cell.t = "s";  // cell type: string
                cell.z = "@";  // 格式：文字
            }
        }

        XLSX.utils.book_append_sheet(wb, ws, "盤點");

        const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
        const blob = new Blob([wbout], {
            type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        });

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const today = new Date().toISOString().slice(0,10);
        a.href = url;
        a.download = `inventory_${today}.xlsx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        alert("已匯出 Excel（資料仍保留在這支手機中，如需清掉請按「清空全部」或逐筆刪除）。");
    });

    // ===== 4. 清空全部資料 =====
    clearAllBtn.addEventListener("click", function() {
        if (!confirm("確定要清空全部資料嗎？這支手機目前的盤點資料會全部刪除，且無法復原。")) {
            return;
        }
        records.length = 0;
        renderTable();
        try {
            localStorage.removeItem(STORAGE_KEY);
        } catch (e) {
            console.warn("清除 localStorage 失敗：", e);
        }
    });
</script>
</body>
</html>
